<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Auctions Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      max-width: 1400px; 
      margin: 0 auto; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    h2, h3, h4 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-top: 0;
    }
    
    /* Header Info Section */
    .header-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 1px solid #ddd;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .info-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .info-label {
      font-weight: bold;
      color: #2c3e50;
      font-size: 14px;
    }
    
    .info-value {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #3498db;
      font-size: 14px;
    }
    
    .info-value.eth {
      color: #f39c12;
    }
    
    /* Auction Lists */
    .auction-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .auction-header {
      display: grid;
      grid-template-columns: 60px 150px 200px 120px 150px 120px 120px 150px;
      gap: 12px;
      padding: 15px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      font-weight: bold;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .auction-item {
      display: grid;
      grid-template-columns: 60px 150px 200px 120px 150px 120px 120px 150px;
      gap: 12px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 10px;
      align-items: center;
      transition: all 0.3s ease;
      background: white;
    }
    
    .auction-item:hover {
      background: #f8f9fa;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .auction-item.ended {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
    }
    
    .auction-item.cancelled {
      background: #ffebee;
      border-left: 4px solid #f44336;
    }
    
    .auction-item.fulfilled {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
    }
    
    /* Address display */
    .address {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #3498db;
      background: #f8f9fa;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    
    /* Status badges */
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      display: inline-block;
      min-width: 100px;
    }
    
    .status.active {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.ended {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status.cancelled {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.fulfilled {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* Role badges */
    .role {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      display: inline-block;
      min-width: 100px;
    }
    
    .role.seller {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #b1dfbb;
    }
    
    .role.bidder {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border: 1px solid #abdde5;
    }
    
    .role.spectator {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #6c757d;
      border: 1px solid #dee2e6;
    }
    
    /* Buttons */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-bid {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    
    .btn-cancel {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }
    
    .btn-fulfill {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }
    
    .btn-claim {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }
    
    .btn-create {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      padding: 12px 25px;
      font-size: 16px;
    }
    
    .btn-refresh {
      background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
      color: white;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 15px;
    }
    
    /* Form controls */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #495057;
    }
    
    input, select {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      width: 300px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    /* Bid controls */
    .bid-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .bid-input {
      width: 120px;
      padding: 8px 12px;
      border: 2px solid #28a745;
      border-radius: 6px;
      font-weight: bold;
    }
    
    /* Create Auction Form */
    .create-form {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 15px;
      border: 2px dashed #6c757d;
    }
    
    .form-row {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    
    /* Status messages */
    .status-message {
      margin-top: 15px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status-message.success {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #b1dfbb;
    }
    
    .status-message.error {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 1px solid #f1b0b7;
    }
    
    .status-message.info {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border: 1px solid #abdde5;
    }
    
    /* Connection status */
    .connection-status {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .connected {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    
    .disconnected {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }
    
    /* Price display */
    .price {
      font-weight: bold;
      color: #27ae60;
      font-size: 16px;
    }
    
    /* Time display */
    .time-left {
      font-family: 'Courier New', monospace;
      color: #e74c3c;
      font-weight: bold;
    }
    
    /* No items message */
    .no-items {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #dee2e6;
    }
    
    /* Grid layout */
    .sections-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      margin-top: 30px;
    }
    
    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .auction-header,
      .auction-item {
        grid-template-columns: 50px 120px 150px 100px 120px 100px 100px 120px;
        font-size: 12px;
      }
      
      .header-info {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .sections-grid {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="connection-status connected" id="connectionStatus">
    ‚óè Connected
  </div>
  
  <button class="btn-refresh" onclick="refreshAll()">üîÑ Refresh</button>
  
  <h1>üèõÔ∏è Live Auctions Platform</h1>
  
  <div class="container">
    <!-- Section 1: Header Info -->
    <div class="header-info">
      <div class="info-item">
        <div class="info-label">Your Wallet Address</div>
        <div id="currentAddress" class="info-value address">Not connected</div>
      </div>
      <div class="info-item">
        <div class="info-label">Contract Owner</div>
        <div id="ownerAddress" class="info-value address">Loading...</div>
      </div>
      <div class="info-item">
        <div class="info-label">Contract Balance</div>
        <div id="contractBalance" class="info-value eth">0.000 ETH</div>
      </div>
      <div class="info-item">
        <div class="info-label">Collected Fees (20%)</div>
        <div id="collectedFees" class="info-value eth">0.000 ETH</div>
      </div>
    </div>
    
    <!-- Section 2: Create Auction -->
    <div class="auction-section">
      <h3>üì¶ Create New Auction (Fee: 0.02 ETH)</h3>
      <div class="create-form">
        <div class="form-row">
          <div class="form-group">
            <label for="auctionTitle">Product Title (Unique)</label>
            <input type="text" id="auctionTitle" placeholder="e.g., Vintage Camera 1950">
          </div>
          <div class="form-group">
            <label for="startingPriceEth">Starting Price (ETH)</label>
            <input type="number" id="startingPriceEth" placeholder="0.01" step="0.001" min="0.001">
          </div>
          <div class="form-group">
            <label for="auctionDuration">Duration (blocks)</label>
            <input type="number" id="auctionDuration" placeholder="100 blocks (~25 minutes)" min="1">
          </div>
          <button class="btn-create" onclick="createAuction()">
            üöÄ Create Auction
          </button>
        </div>
        <div id="createStatus" class="status-message"></div>
      </div>
    </div>
    
    <!-- Section 3: Live Auctions -->
    <div class="auction-section">
      <h3>üî• Live Auctions</h3>
      <div class="auction-header">
        <span>ID</span>
        <span>Seller</span>
        <span>Title</span>
        <span>Current Price</span>
        <span>Time Left</span>
        <span>Your Role</span>
        <span>Status</span>
        <span>Action</span>
      </div>
      <div id="auctionList" class="auction-list">
        <div class="no-items">Loading auctions...</div>
      </div>
    </div>
    
    <div class="sections-grid">
      <!-- Section 4: Fulfilled Auctions -->
      <div class="auction-section">
        <h3>‚úÖ Fulfilled Auctions</h3>
        <div class="auction-header" style="grid-template-columns: 60px 150px 200px 120px 150px;">
          <span>ID</span>
          <span>Seller</span>
          <span>Title</span>
          <span>Final Price</span>
          <span>Winner</span>
        </div>
        <div id="fulfilledAuctionList">
          <div class="no-items">No fulfilled auctions yet</div>
        </div>
      </div>
      
      <!-- Section 5: Cancelled Auctions -->
      <div class="auction-section">
        <h3>‚ùå Cancelled Auctions</h3>
        <div class="auction-header" style="grid-template-columns: 60px 150px 200px 100px;">
          <span>ID</span>
          <span>Seller</span>
          <span>Title</span>
          <span>Status</span>
        </div>
        <div id="cancelledAuctionList">
          <div class="no-items">No cancelled auctions</div>
        </div>
        
        <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 10px; border: 2px solid #ffc107;">
          <h4 style="color: #856404;">üí∞ Claim Your Refunds</h4>
          <p id="claimInfo" style="margin: 10px 0; font-weight: bold; color: #856404;">You have no refunds to claim</p>
          <div style="display: flex; gap: 15px; align-items: center;">
            <button class="btn-claim" id="claimBtn" onclick="claimRefunds()" disabled>
              üí∞ Claim Refunds
            </button>
            <div id="claimStatus" class="status-message" style="flex: 1; margin: 0;"></div>
          </div>
        </div>
      </div>
    </div>
    
      
    <!-- Section 6: Admin Controls -->
   <div class="auction-section">
    <h3>‚öôÔ∏è Admin Controls</h3>
    <div id="adminControls" style="display: none; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; border: 2px solid #6c757d;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
      
      <!-- Withdraw Platform Fees -->
        <div>
          <h4>Withdraw Platform Fees</h4>
          <div style="margin-top: 10px;">
           <button class="btn-claim" onclick="withdrawFees()">üí∏ Withdraw All Fees</button>
         </div>
         <p id="adminStatus" class="status-message" style="margin-top: 10px;"></p>
        </div>

          <div>
            <h4>Transfer Ownership</h4>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="newOwner" placeholder="New owner address" style="flex: 1;">
              <button class="btn-bid" onclick="changeOwner()">üëë Transfer</button>
            </div>
          </div>
          <div>
            <h4>Ban Seller</h4>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <input type="text" id="sellerToBan" placeholder="Seller address to ban" style="flex: 1;">
              <button class="btn-cancel" onclick="banSeller()">üö´ Ban</button>
            </div>
          </div>
        </div>
        <div style="margin-top: 25px; padding: 20px; background: #ffebee; border-radius: 10px; border: 2px solid #f44336;">
          <h4 style="color: #c62828;">‚ö†Ô∏è DESTROY CONTRACT</h4>
          <p style="margin: 10px 0; color: #c62828; font-weight: bold;">This action is IRREVERSIBLE! All active auctions will be cancelled.</p>
          <button class="btn-cancel pulse" onclick="destroyContract()">
            üí• Destroy Contract
          </button>
        </div>
        <div id="adminStatus" class="status-message" style="margin-top: 20px;"></div>
      </div>
      <div id="notOwnerMessage" style="text-align: center; padding: 30px; color: #6c757d; font-style: italic;">
        <p>‚ö†Ô∏è Only the contract owner can access these controls.</p>
      </div>
    </div>
  </div>

  <script>
    const contractAddress = "0x5f53dDC137f0f4A4147aB8949b479bb41CCb15e5";
    let web3;
    let contract;
    let currentAddress;
    let isOwner = false;
    let contractDestroyed = false;

    // Contract ABI 
    const contractABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "AuctionCancelled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "startPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "endBlock",
				"type": "uint256"
			}
		],
		"name": "AuctionCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "winner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountToSeller",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "fee",
				"type": "uint256"
			}
		],
		"name": "AuctionEnded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "auctionId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "sellerAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "feeAmount",
				"type": "uint256"
			}
		],
		"name": "AuctionFulfilled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "by",
				"type": "address"
			}
		],
		"name": "ContractDestroyed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "bidder",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "totalBid",
				"type": "uint256"
			}
		],
		"name": "NewBid",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "by",
				"type": "address"
			}
		],
		"name": "Paused",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bidder",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RefundClaimed",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "AUCTION_FEE",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "SUPER_ADMIN",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "auctions",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "address payable",
				"name": "seller",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "startPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "highestBid",
				"type": "uint256"
			},
			{
				"internalType": "address payable",
				"name": "highestBidder",
				"type": "address"
			},
			{
				"internalType": "enum AuctionContract.State",
				"name": "state",
				"type": "uint8"
			},
			{
				"internalType": "uint256",
				"name": "endBlock",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "ban",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "banned",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "bids",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "cancelAuction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "claimRefund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "startPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "durationBlocks",
				"type": "uint256"
			}
		],
		"name": "createAuction",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "destroyContract",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "endAuction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "auctionId",
				"type": "uint256"
			}
		],
		"name": "fulfillAuction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getActiveAuctions",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "ids",
				"type": "uint256[]"
			},
			{
				"internalType": "address[]",
				"name": "sellers",
				"type": "address[]"
			},
			{
				"internalType": "string[]",
				"name": "titles",
				"type": "string[]"
			},
			{
				"internalType": "uint256[]",
				"name": "currentPrices",
				"type": "uint256[]"
			},
			{
				"internalType": "uint256[]",
				"name": "endBlocks",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getCancelledAuctions",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "address payable",
						"name": "seller",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "startPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "highestBid",
						"type": "uint256"
					},
					{
						"internalType": "address payable",
						"name": "highestBidder",
						"type": "address"
					},
					{
						"internalType": "enum AuctionContract.State",
						"name": "state",
						"type": "uint8"
					},
					{
						"internalType": "uint256",
						"name": "endBlock",
						"type": "uint256"
					}
				],
				"internalType": "struct AuctionContract.Auction[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getEndedAuctions",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "address payable",
						"name": "seller",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "startPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "highestBid",
						"type": "uint256"
					},
					{
						"internalType": "address payable",
						"name": "highestBidder",
						"type": "address"
					},
					{
						"internalType": "enum AuctionContract.State",
						"name": "state",
						"type": "uint8"
					},
					{
						"internalType": "uint256",
						"name": "endBlock",
						"type": "uint256"
					}
				],
				"internalType": "struct AuctionContract.Auction[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "getHighestBidder",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "newBid",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nextAuctionId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pauseContract",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pendingPlatformFees",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "pendingRefunds",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalCollected",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "unban",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdrawPlatformFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

    // -------------------
    // Initialization
    // -------------------
    document.addEventListener("DOMContentLoaded", async () => {
      if (!window.ethereum) {
        alert("Please install MetaMask to use this dApp");
        return;
      }

      try {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        currentAddress = accounts[0];
        
        updateConnectionUI();
        
        contract = new web3.eth.Contract(contractABI, contractAddress);
        
        await checkOwnerStatus();
        await refreshAll();
        setupEventListeners();
        setupContractEvents();
        
      } catch (error) {
        console.error("Initialization error:", error);
        alert("Error: " + error.message);
      }
    });

    async function checkOwnerStatus() {
      try {
        const owner = await contract.methods.owner().call();
        isOwner = owner.toLowerCase() === currentAddress.toLowerCase();
        
        const adminControls = document.getElementById("adminControls");
        const notOwnerMessage = document.getElementById("notOwnerMessage");
        const createBtn = document.querySelector(".btn-create");
        
        if (isOwner) {
          adminControls.style.display = "block";
          notOwnerMessage.style.display = "none";
          if (createBtn) {
            createBtn.disabled = true;
            createBtn.title = "Contract owner cannot create auctions";
            createBtn.style.opacity = "0.5";
          }
        } else {
          adminControls.style.display = "none";
          notOwnerMessage.style.display = "block";
          if (createBtn) {
            createBtn.disabled = false;
            createBtn.title = "";
            createBtn.style.opacity = "1";
          }
        }
      } catch (error) {
        console.error("Error checking owner:", error);
      }
    }

    function updateConnectionUI() {
      const addressElement = document.getElementById("currentAddress");
      const statusElement = document.getElementById("connectionStatus");
      
      if (addressElement) {
        addressElement.textContent = currentAddress ? 
          `${currentAddress.slice(0, 6)}...${currentAddress.slice(-4)}` : 
          "Not connected";
      }
      
      if (statusElement) {
        if (currentAddress) {
          statusElement.textContent = "‚óè Connected";
          statusElement.className = "connection-status connected";
        } else {
          statusElement.textContent = "‚óè Disconnected";
          statusElement.className = "connection-status disconnected";
        }
      }
    }

    function setupEventListeners() {
      window.ethereum.on('accountsChanged', async (accounts) => {
        currentAddress = accounts[0] || null;
        updateConnectionUI();
        await checkOwnerStatus();
        await refreshAll();
      });
      
      window.ethereum.on('chainChanged', () => {
        location.reload();
      });
    }

    function setupContractEvents() {
     contract.events.AuctionCreated({}, () => refreshAll());
     contract.events.NewBid({}, () => refreshAll());
     contract.events.AuctionCancelled({}, () => refreshAll());
     contract.events.AuctionEnded({}, () => refreshAll());
     contract.events.AuctionFulfilled({}, () => refreshAll());
   }


    // -------------------
    // Refresh All Data
    // -------------------
    async function refreshAll() {
      console.log("Refreshing all data...");
      try {
        await updateHeaderInfo();
        await loadAllAuctions();
        await loadFulfilledAuctions();
        await loadCancelledAuctions();
        await updateClaimUI();
        console.log("Refresh completed successfully");
      } catch (error) {
        console.error("Refresh error:", error);
      }
    }

    // -------------------
    // Section 1: Header Info (Real-time updates)
    // -------------------
    async function updateHeaderInfo() {
      try {
        // Contract owner
        const owner = await contract.methods.owner().call();
        document.getElementById('ownerAddress').textContent = 
          `${owner.slice(0, 6)}...${owner.slice(-4)}`;
        
        // Contract balance
        const balance = await web3.eth.getBalance(contractAddress);
        const balanceEth = web3.utils.fromWei(balance, 'ether');
        document.getElementById('contractBalance').textContent = 
          `${parseFloat(balanceEth).toFixed(3)} ETH`;
        
        // Collected fees (20% of fulfilled auctions)
        const fees = await contract.methods.totalCollected().call();
        const feesEth = web3.utils.fromWei(fees, 'ether');
        document.getElementById('collectedFees').textContent = 
          `${parseFloat(feesEth).toFixed(3)} ETH`;
        
      } catch (error) {
        console.error("Error updating header:", error);
      }
    }

    // -------------------
    // Section 2: Create Auction
    // -------------------
    async function createAuction() {
     const title = document.getElementById('auctionTitle').value.trim();
     const price = document.getElementById('startingPriceEth').value.trim();
     const duration = document.getElementById('auctionDuration').value.trim();
     const statusElement = document.getElementById('createStatus');

  if (!title || !price || !duration) {
    alert("Please fill all fields");
    return;
  }

  if (parseFloat(price) <= 0) {
    alert("Starting price must be greater than 0");
    return;
  }

  if (parseInt(duration) <= 0) {
    alert("Duration must be greater than 0 blocks");
    return;
  }

  const startPriceWei = web3.utils.toWei(price, 'ether');
  const feeWei = web3.utils.toWei('0.02', 'ether');

  statusElement.textContent = "Creating auction...";
  statusElement.className = "status-message info";

  try {
    await contract.methods.createAuction(title, startPriceWei, duration)
      .send({
        from: currentAddress,
        value: feeWei,
        gas: 300000
      })
      .on('transactionHash', (hash) => {
        console.log("Transaction hash:", hash);
        statusElement.textContent = `Transaction sent: ${hash.slice(0, 10)}...`;
      })
      .on('receipt', () => {
        statusElement.textContent = "‚úÖ Auction created successfully!";
        statusElement.className = "status-message success";

        // Clear form
        document.getElementById('auctionTitle').value = '';
        document.getElementById('startingPriceEth').value = '';
        document.getElementById('auctionDuration').value = '';

        loadAllAuctions();

        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = "status-message";
        }, 3000);
      })
      .on('error', (error) => {
        console.error("Transaction error:", error);
        statusElement.textContent =
          "‚ùå Error: " + (error.message || "Transaction failed");
        statusElement.className = "status-message error";
      });

  } catch (error) {
    console.error("Create auction error:", error);
    statusElement.textContent = "‚ùå Error: " + error.message;
    statusElement.className = "status-message error";
  }
 }

    

 // -------------------
// Section 3: Live Auctions 
// -------------------
async function loadAllAuctions() {
  const container = document.getElementById('auctionList');
  container.innerHTML = '<div class="no-items">Loading auctions...</div>';

  try {
    const currentBlock = await web3.eth.getBlockNumber();
    const nextId = await contract.methods.nextAuctionId().call();
    
    if (nextId <= 1) {
      container.innerHTML = '<div class="no-items">No auctions found</div>';
      return;
    }

    container.innerHTML = ''; // ŒöŒ±Œ∏Œ±œÅŒØŒ∂ŒøœÖŒºŒµ œÑŒø loading message
    let hasAuctions = false;

    // ŒîŒπŒ±Œ≤Œ¨Œ∂ŒøœÖŒºŒµ œåŒªŒ± œÑŒ± auctions Œ≠ŒΩŒ±-Œ≠ŒΩŒ±
    for (let i = 1; i < nextId; i++) {
      try {
        const auction = await contract.methods.auctions(i).call();
        const auctionState = Number(auction.state);
        
        // Œ†Œ±œÅŒ±ŒªŒµŒØœÄŒøœÖŒºŒµ œÑŒ± fulfilled Œ∫Œ±Œπ cancelled
        if (auctionState === 2 || auctionState === 3) continue;
        
        const id = Number(auction.id);
        const seller = auction.seller;
        const title = auction.title;
        const currentPriceWei = auction.highestBid > 0 ? auction.highestBid : auction.startPrice;
        const currentPriceEth = web3.utils.fromWei(currentPriceWei.toString(), 'ether');
        
        // User role
        let userRole = 'spectator';
        let roleText = 'Spectator';
        if (seller.toLowerCase() === currentAddress.toLowerCase()) {
          userRole = 'seller';
          roleText = 'Seller';
        } else if (
          auction.highestBidder &&
          auction.highestBidder.toLowerCase() === currentAddress.toLowerCase()
        ) {
          userRole = 'bidder';
          roleText = 'Highest Bidder';
        }

        // Determine auction status
        let isActive = false;
        let isEndedButNotFulfilled = false;
        let needsAutoEnd = false;
        
        if (auctionState === 0) { // State.Active
          if (currentBlock < auction.endBlock) {
            isActive = true;
          } else {
            // Time has expired - try to auto-end
            needsAutoEnd = true;
            isEndedButNotFulfilled = true;
          }
        } else if (auctionState === 1) { // State.Ended
          isEndedButNotFulfilled = true;
        }

        // ŒëŒ•Œ§ŒüŒúŒëŒ§Œü END - ŒúœåŒΩŒø Œ±ŒΩ Œø œáœÅŒÆœÉœÑŒ∑œÇ ŒµŒØŒΩŒ±Œπ seller
        if (needsAutoEnd && userRole === 'seller') {
          try {
            console.log(`Auto-ending auction ${id}...`);
            await contract.methods.endAuction(id)
              .send({
                from: currentAddress,
                gas: 150000
              });
            
            // After auto-end, refresh the auction data
            const updatedAuction = await contract.methods.auctions(id).call();
            auction.state = updatedAuction.state;
            auctionState = Number(updatedAuction.state);
            
            // Update status after auto-end
            if (auctionState === 1) {
              isEndedButNotFulfilled = true;
              needsAutoEnd = false;
            }
            
            console.log(`Auction ${id} auto-ended successfully`);
          } catch (error) {
            console.warn(`Could not auto-end auction ${id}:`, error.message);
            // Œ†œÅŒøœáœâœÅŒ¨ŒºŒµ ŒºŒµ œÑŒø original state
          }
        }

        // Time left / Status
        let timeLeft = '-';
        let statusText = '';
        
        if (isActive) {
          const blocksLeft = auction.endBlock - currentBlock;
          const minutes = Math.max(Math.floor((blocksLeft * 15) / 60), 1);
          timeLeft = `${blocksLeft} blocks (‚âà${minutes}min)`;
          statusText = 'Active';
        } else if (isEndedButNotFulfilled) {
          statusText = 'Ended';
          if (needsAutoEnd) {
            timeLeft = 'EXPIRED';
            statusText = 'Expired (needs seller)';
          } else {
            const blocksPassed = currentBlock - auction.endBlock;
            const hoursPassed = Math.floor((blocksPassed * 15) / 3600);
            if (hoursPassed > 0) {
              timeLeft = `Ended ${hoursPassed}h ago`;
            } else {
              timeLeft = 'Recently ended';
            }
          }
        }

        // Action buttons
        let actionHTML = '';
        
        if (isActive) {
          if (userRole === 'seller') {
            actionHTML = `<button class="btn-cancel" onclick="cancelAuction(${id})">Cancel</button>`;
          } else if (userRole === 'spectator') {
            const minBid = (parseFloat(currentPriceEth) + 0.001).toFixed(3);
            actionHTML = `
              <div class="bid-controls">
                <input type="number" class="bid-input" step="0.001" min="${minBid}" value="${minBid}">
                <button class="btn-bid" onclick="placeBid(${id})">Bid</button>
              </div>
            `;
          } else {
            actionHTML = '-';
          }
        } else if (isEndedButNotFulfilled) {
          // Already ended, ready for fulfill
          if (userRole === 'seller') {
            if (auction.highestBid > 0) {
              actionHTML = `<button class="btn-fulfill" onclick="fulfillAuction(${id})">Fulfill</button>`;
            } else {
              actionHTML = `<button class="btn-cancel" onclick="cancelAuction(${id})">Cancel</button>`;
            }
          } else if (userRole === 'bidder') {
            actionHTML = '<span style="color: #666;">Waiting for seller...</span>';
          } else {
            actionHTML = '-';
          }
        }

        // Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑ œÑŒøœÖ auction œÉœÑŒ∑ ŒªŒØœÉœÑŒ± ŒºœåŒΩŒø Œ±ŒΩ:
        // 1. ŒïŒØŒΩŒ±Œπ active, ŒÆ
        // 2. ŒïŒØŒΩŒ±Œπ ended Œ∫Œ±Œπ Œø œáœÅŒÆœÉœÑŒ∑œÇ ŒµŒØŒΩŒ±Œπ seller ŒÆ bidder
        const shouldShow = isActive || 
                          (isEndedButNotFulfilled && (userRole === 'seller' || userRole === 'bidder'));
        
        if (shouldShow) {
          hasAuctions = true;
          const item = document.createElement('div');
          item.className = 'auction-item ' + (isActive ? 'active' : 'ended');
          item.dataset.id = id;
          item.innerHTML = `
            <span>#${id}</span>
            <span class="address" title="${seller}">${seller.slice(0,6)}...${seller.slice(-4)}</span>
            <span title="${title}">${title.length > 20 ? title.substring(0, 20) + '...' : title}</span>
            <span class="price">${parseFloat(currentPriceEth).toFixed(3)} ETH</span>
            <span class="time-left">${timeLeft}</span>
            <span class="role ${userRole}">${roleText}</span>
            <span class="status ${isActive ? 'active' : 'ended'}">${statusText}</span>
            <span>${actionHTML}</span>
          `;
          container.appendChild(item);
        }
      } catch (error) {
        console.warn(`Error loading auction ${i}:`, error);
        continue;
      }
    }

    if (!hasAuctions) {
      container.innerHTML = '<div class="no-items">No auctions to display</div>';
    }
  } catch (error) {
    console.error('Error loading auctions:', error);
    container.innerHTML = '<div class="no-items error">Error loading auctions</div>';
  }
}

// -------------------
// End Auction Function 
// -------------------
async function endAuction(auctionId) {
  if (!confirm("End this auction? This will move it to 'Ended' state where you can fulfill it to receive payment.")) return;
  
  try {
    await contract.methods.endAuction(auctionId)
      .send({
        from: currentAddress,
        gas: 200000
      })
      .on('transactionHash', () => {
        // ŒîŒµŒØŒæŒµ loading state
        const item = document.querySelector(`.auction-item[data-id="${auctionId}"]`);
        if (item) {
          const actionSpan = item.querySelector('span:last-child');
          actionSpan.innerHTML = '<span style="color: #666;">Ending...</span>';
        }
      })
      .on('receipt', () => {
        alert("‚úÖ Auction ended successfully! You can now fulfill it to receive payment.");
        loadAllAuctions(); // Refresh the list
      })
      .on('error', (error) => {
        alert("‚ùå Failed to end auction: " + error.message);
      });
  } catch (error) {
    console.error("End auction error:", error);
    alert("Error: " + error.message);
  }
}


    // -------------------
    // Place Bid
    // -------------------
    async function placeBid(auctionId) {
      try {
        const auctionItem = document.querySelector(`.auction-item[data-id="${auctionId}"]`);
        if (!auctionItem) return;
        
        const bidInput = auctionItem.querySelector('.bid-input');
        const bidAmount = bidInput.value.trim();
        
        if (!bidAmount || parseFloat(bidAmount) <= 0) {
          alert("Please enter a valid bid amount");
          return;
        }
        
        const auction = await contract.methods.auctions(auctionId).call();
        const currentPrice = auction.highestBid > 0 ? auction.highestBid : auction.startPrice;
        const currentPriceEth = web3.utils.fromWei(currentPrice, 'ether');
        const minBid = parseFloat(currentPriceEth) + 0.001;
        
        if (parseFloat(bidAmount) < minBid) {
          alert(`Minimum bid is ${minBid.toFixed(3)} ETH`);
          bidInput.value = minBid.toFixed(3);
          return;
        }
        
        const bidWei = web3.utils.toWei(bidAmount, 'ether');
        
        await contract.methods.newBid(auctionId)
          .send({
            from: currentAddress,
            value: bidWei,
            gas: 200000
          })
          .on('transactionHash', () => {
            bidInput.disabled = true;
            auctionItem.querySelector('.btn-bid').disabled = true;
            auctionItem.querySelector('.btn-bid').textContent = "Processing...";
          })
          .on('receipt', () => {
            alert("‚úÖ Bid placed successfully!");
            refreshAll();
          })
          .on('error', (error) => {
            alert("‚ùå Bid failed: " + error.message);
          });
          
      } catch (error) {
        console.error("Place bid error:", error);
        alert("Error: " + error.message);
      }
    }

    // -------------------
    // Cancel Auction
    // -------------------
    async function cancelAuction(auctionId) {
      if (!confirm("Are you sure you want to cancel this auction?")) return;
      
      try {
        await contract.methods.cancelAuction(auctionId)
          .send({
            from: currentAddress,
            gas: 200000
          })
          .on('receipt', () => {
            alert("‚úÖ Auction cancelled successfully!");
            refreshAll();
          })
          .on('error', (error) => {
            alert("‚ùå Cancellation failed: " + error.message);
          });
          
      } catch (error) {
        console.error("Cancel auction error:", error);
        alert("Error: " + error.message);
      }
    }

    // -------------------
    // Fulfill Auction
    // -------------------
    async function fulfillAuction(auctionId) {
      const auction = await contract.methods.auctions(auctionId).call();
      const finalPrice = web3.utils.fromWei(auction.highestBid, 'ether');
      const sellerAmount = (parseFloat(finalPrice) * 0.8).toFixed(3);
      const feeAmount = (parseFloat(finalPrice) * 0.2).toFixed(3);
      
      const confirmMsg = `Fulfill Auction #${auctionId}\n\n` +
                        `Item: ${auction.title}\n` +
                        `Final Price: ${finalPrice} ETH\n\n` +
                        `Seller receives: ${sellerAmount} ETH (80%)\n` +
                        `Platform fee: ${feeAmount} ETH (20%)\n\n` +
                        `Proceed with fulfillment?`;
      
      if (!confirm(confirmMsg)) return;
      
      try {
        await contract.methods.fulfillAuction(auctionId)
          .send({
            from: currentAddress,
            gas: 250000
          })
          .on('receipt', () => {
            alert("‚úÖ Auction fulfilled successfully!");
            refreshAll();
          })
          .on('error', (error) => {
            alert("‚ùå Fulfillment failed: " + error.message);
          });
          
      } catch (error) {
        console.error("Fulfill auction error:", error);
        alert("Error: " + error.message);
      }
    }

    // -------------------
    // Section 4: Fulfilled Auctions
    // -------------------
    async function loadFulfilledAuctions() {
      try {
        const container = document.getElementById('fulfilledAuctionList');
        
        // We need to check each auction since there's no getFulfilledAuctions function
        const nextId = await contract.methods.nextAuctionId().call();
        
        container.innerHTML = '';
        
        let hasFulfilled = false;
        
        for (let i = 1; i < nextId; i++) {
          try {
            const auction = await contract.methods.auctions(i).call();
            
            if (auction.state == 2) { // Fulfilled
              hasFulfilled = true;
              const finalPrice = web3.utils.fromWei(auction.highestBid, 'ether');
              
              const item = document.createElement('div');
              item.className = 'auction-item fulfilled';
              
              item.innerHTML = `
                <span>#${i}</span>
                <span class="address" title="${auction.seller}">${auction.seller.slice(0, 6)}...${auction.seller.slice(-4)}</span>
                <span title="${auction.title}">${auction.title || 'Untitled'}</span>
                <span class="price">${parseFloat(finalPrice).toFixed(3)} ETH</span>
                <span class="address" title="${auction.highestBidder || 'No winner'}">
                  ${auction.highestBidder ? 
                    `${auction.highestBidder.slice(0, 6)}...${auction.highestBidder.slice(-4)}` : 
                    'No winner'}
                </span>
              `;
              
              container.appendChild(item);
            }
          } catch (error) {
            continue;
          }
        }
        
        if (!hasFulfilled) {
          container.innerHTML = '<div class="no-items">No fulfilled auctions yet</div>';
        }
        
      } catch (error) {
        console.error("Error loading fulfilled auctions:", error);
      }
    }

    // -------------------
    // Section 5: Cancelled Auctions & Claim
    // -------------------
    async function loadCancelledAuctions() {
      try {
        const container = document.getElementById('cancelledAuctionList');
        
        // Use getCancelledAuctions if available
        try {
          const cancelledAuctions = await contract.methods.getCancelledAuctions().call();
          
          container.innerHTML = '';
          
          if (cancelledAuctions.length === 0) {
            container.innerHTML = '<div class="no-items">No cancelled auctions</div>';
            return;
          }
          
          for (const auction of cancelledAuctions) {
            const item = document.createElement('div');
            item.className = 'auction-item cancelled';
            
            item.innerHTML = `
              <span>#${auction.id}</span>
              <span class="address" title="${auction.seller}">${auction.seller.slice(0, 6)}...${auction.seller.slice(-4)}</span>
              <span title="${auction.title}">${auction.title || 'Untitled'}</span>
              <span class="status cancelled">Cancelled</span>
            `;
            
            container.appendChild(item);
          }
        } catch (e) {
          // Fallback method
          const nextId = await contract.methods.nextAuctionId().call();
          
          container.innerHTML = '';
          
          let hasCancelled = false;
          
          for (let i = 1; i < nextId; i++) {
            try {
              const auction = await contract.methods.auctions(i).call();
              
              if (auction.state == 3) { // Cancelled
                hasCancelled = true;
                
                const item = document.createElement('div');
                item.className = 'auction-item cancelled';
                
                item.innerHTML = `
                  <span>#${i}</span>
                  <span class="address" title="${auction.seller}">${auction.seller.slice(0, 6)}...${auction.seller.slice(-4)}</span>
                  <span title="${auction.title}">${auction.title || 'Untitled'}</span>
                  <span class="status cancelled">Cancelled</span>
                `;
                
                container.appendChild(item);
              }
            } catch (error) {
              continue;
            }
          }
          
          if (!hasCancelled) {
            container.innerHTML = '<div class="no-items">No cancelled auctions</div>';
          }
        }
        
      } catch (error) {
        console.error("Error loading cancelled auctions:", error);
      }
    }

    async function updateClaimUI() {
      try {
        const pending = await contract.methods.pendingRefunds(currentAddress).call();
        const pendingEth = web3.utils.fromWei(pending, 'ether');
        const claimBtn = document.getElementById('claimBtn');
        const claimInfo = document.getElementById('claimInfo');
        
        if (parseFloat(pendingEth) > 0) {
          claimBtn.disabled = false;
          claimInfo.textContent = `You can claim ${parseFloat(pendingEth).toFixed(3)} ETH`;
        } else {
          claimBtn.disabled = true;
          claimInfo.textContent = "You have no refunds to claim";
        }
      } catch (error) {
        console.error("Error updating claim UI:", error);
      }
    }

    async function claimRefunds() {
      const statusElement = document.getElementById('claimStatus');
      statusElement.textContent = "Processing claim...";
      statusElement.className = "status-message info";
      
      try {
        await contract.methods.claimRefund()
          .send({
            from: currentAddress,
            gas: 100000
          })
          .on('receipt', () => {
            statusElement.textContent = "‚úÖ Refunds claimed successfully!";
            statusElement.className = "status-message success";
            updateClaimUI();
            setTimeout(() => {
              statusElement.textContent = '';
              statusElement.className = "status-message";
            }, 3000);
          })
          .on('error', (error) => {
            statusElement.textContent = "‚ùå Claim failed: " + error.message;
            statusElement.className = "status-message error";
          });
          
      } catch (error) {
        console.error("Claim error:", error);
        statusElement.textContent = "‚ùå Error: " + error.message;
        statusElement.className = "status-message error";
      }
    }

    // -------------------
    // Section 6: Admin Controls
    // -------------------
    async function withdrawFees() {
     if (!isOwner) {
       alert("Only contract owner can withdraw fees");
     return;
     }

   const statusElement = document.getElementById('adminStatus');
   statusElement.textContent = "Processing withdrawal...";
   statusElement.className = "status-message info";

   try {
     await contract.methods.withdrawPlatformFees()
      .send({ from: currentAddress, gas: 200000 })
      .on('receipt', () => {
        statusElement.textContent = "‚úÖ Fees withdrawn successfully!";
        statusElement.className = "status-message success";
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = "status-message";
        }, 3000);
      })
      .on('error', (error) => {
        statusElement.textContent = "‚ùå Withdrawal failed: " + error.message;
        statusElement.className = "status-message error";
      });
    } catch (error) {
    console.error("Withdraw error:", error);
    statusElement.textContent = "‚ùå Error: " + error.message;
    statusElement.className = "status-message error";
    }
   }

    async function changeOwner() {
      if (!isOwner) {
        alert("Only contract owner can change owner");
        return;
      }
      
      const newOwner = document.getElementById('newOwner').value.trim();
      if (!newOwner || !web3.utils.isAddress(newOwner)) {
        alert("Please enter a valid Ethereum address");
        return;
      }
      
      if (!confirm(`Transfer ownership to ${newOwner}? This action cannot be undone!`)) {
        return;
      }
      
      const statusElement = document.getElementById('adminStatus');
      statusElement.textContent = "Transferring ownership...";
      statusElement.className = "status-message info";
      
      try {
        await contract.methods.transferOwnership(newOwner)
          .send({
            from: currentAddress,
            gas: 100000
          })
          .on('receipt', () => {
            statusElement.textContent = "‚úÖ Ownership transferred successfully!";
            statusElement.className = "status-message success";
            document.getElementById('newOwner').value = '';
            setTimeout(() => {
              statusElement.textContent = '';
              statusElement.className = "status-message";
              checkOwnerStatus();
            }, 3000);
          })
          .on('error', (error) => {
            statusElement.textContent = "‚ùå Transfer failed: " + error.message;
            statusElement.className = "status-message error";
          });
          
      } catch (error) {
        console.error("Change owner error:", error);
        statusElement.textContent = "‚ùå Error: " + error.message;
        statusElement.className = "status-message error";
      }
    }

    async function banSeller() {
      if (!isOwner) {
        alert("Only contract owner can ban sellers");
        return;
      }
      
      const seller = document.getElementById('sellerToBan').value.trim();
      if (!seller || !web3.utils.isAddress(seller)) {
        alert("Please enter a valid Ethereum address");
        return;
      }
      
      if (!confirm(`Ban seller ${seller}? This will cancel all their active auctions!`)) {
        return;
      }
      
      const statusElement = document.getElementById('adminStatus');
      statusElement.textContent = "Banning seller...";
      statusElement.className = "status-message info";
      
      try {
        await contract.methods.ban(seller)
          .send({
            from: currentAddress,
            gas: 200000
          })
          .on('receipt', () => {
            statusElement.textContent = "‚úÖ Seller banned successfully!";
            statusElement.className = "status-message success";
            document.getElementById('sellerToBan').value = '';
            setTimeout(() => {
              statusElement.textContent = '';
              statusElement.className = "status-message";
            }, 3000);
          })
          .on('error', (error) => {
            statusElement.textContent = "‚ùå Ban failed: " + error.message;
            statusElement.className = "status-message error";
          });
          
      } catch (error) {
        console.error("Ban seller error:", error);
        statusElement.textContent = "‚ùå Error: " + error.message;
        statusElement.className = "status-message error";
      }
    }

    async function destroyContract() {
      if (!isOwner) {
        alert("Only contract owner can destroy contract");
        return;
      }
      
      if (!confirm("‚ö†Ô∏è DESTROY CONTRACT ‚ö†Ô∏è\n\nThis action is IRREVERSIBLE!\n\n‚Ä¢ All active auctions will be cancelled\n‚Ä¢ Contract will be paused\n‚Ä¢ No new auctions can be created\n\nAre you ABSOLUTELY sure?")) {
        return;
      }
      
      const statusElement = document.getElementById('adminStatus');
      statusElement.textContent = "Destroying contract...";
      statusElement.className = "status-message info";
      
      try {
        await contract.methods.destroyContract()
          .send({
            from: currentAddress,
            gas: 200000
          })
          .on('receipt', () => {
            statusElement.textContent = "‚úÖ Contract destroyed successfully!";
            statusElement.className = "status-message success";
            contractDestroyed = true;
            setTimeout(() => {
              statusElement.textContent = '';
              statusElement.className = "status-message";
              refreshAll();
            }, 3000);
          })
          .on('error', (error) => {
            statusElement.textContent = "‚ùå Destruction failed: " + error.message;
            statusElement.className = "status-message error";
          });
          
      } catch (error) {
        console.error("Destroy contract error:", error);
        statusElement.textContent = "‚ùå Error: " + error.message;
        statusElement.className = "status-message error";
      }
    }

    // Make functions available globally
    window.refreshAll = refreshAll;
    window.createAuction = createAuction;
    window.placeBid = placeBid;
    window.cancelAuction = cancelAuction;
    window.fulfillAuction = fulfillAuction;
    window.claimRefunds = claimRefunds;
    window.withdrawFees = withdrawFees;
    window.changeOwner = changeOwner;
    window.banSeller = banSeller;
    window.destroyContract = destroyContract;
  </script>
</body>
</html>